# Настройка регулярных пожертвований

## Что было сделано

1. **Добавлена поддержка регулярных платежей в ЮKassa:**
   - При создании регулярного пожертвования передается параметр `save_payment_method: true`
   - Сохраняется `payment_method_id` для последующих списаний
   - Поддержка повторных платежей через сохраненный способ оплаты

2. **Создана команда для обработки регулярных платежей:**
   - Команда: `php artisan donations:process-recurring`
   - Автоматически находит все активные регулярные подписки
   - Проверяет, нужно ли создать следующий платеж (по периоду: ежедневно/еженедельно/ежемесячно)
   - Создает новые транзакции с использованием сохраненного `payment_method_id`

3. **Настроено автоматическое расписание:**
   - Команда запускается каждый час через Laravel Scheduler

## Требования

### 1. Подключение рекуррентных платежей в ЮKassa

**Важно:** Для работы регулярных платежей необходимо подключить эту функцию в личном кабинете ЮKassa:

1. Войдите в личный кабинет ЮKassa
2. Обратитесь в техническую поддержку через иконку оператора
3. Запросите подключение функции рекуррентных платежей
4. Ожидайте одобрения (обычно около 3 дней)

Без подключения этой функции регулярные платежи работать не будут!

### 2. Настройка Cron на сервере

Для автоматического запуска команды нужно настроить cron на сервере.

Добавьте в crontab (`crontab -e`):

```bash
* * * * * cd /path/to/your/project && php artisan schedule:run >> /dev/null 2>&1
```

Замените `/path/to/your/project` на реальный путь к вашему проекту.

Эта команда будет запускаться каждую минуту и проверять, нужно ли выполнить запланированные задачи (в нашем случае - обработку регулярных пожертвований каждый час).

### 3. Проверка работы

После настройки можно проверить работу команды вручную:

```bash
php artisan donations:process-recurring
```

Команда выведет:
- Количество найденных активных подписок
- Количество созданных платежей
- Количество ошибок (если есть)

## Как это работает

1. **Первый платеж:**
   - Пользователь создает регулярное пожертвование через виджет
   - При создании платежа в ЮKassa передается `save_payment_method: true`
   - После успешного платежа сохраняется `payment_method_id` в `payment_details`

2. **Повторные платежи:**
   - Каждый час запускается команда `donations:process-recurring`
   - Команда находит все активные регулярные подписки
   - Для каждой подписки проверяет:
     - Есть ли сохраненный `payment_method_id`
     - Наступила ли дата следующего платежа (по периоду)
     - Не создан ли уже платеж на эту дату
   - Если все условия выполнены, создается новый платеж с использованием сохраненного `payment_method_id`
   - ЮKassa автоматически списывает средства с сохраненной карты

## Логирование

Все операции логируются в:
- `storage/logs/laravel.log` - общие логи Laravel
- Консольный вывод команды при ручном запуске

## Отладка

Если регулярные платежи не создаются:

1. Проверьте, подключена ли функция рекуррентных платежей в ЮKassa
2. Проверьте, что у пожертвования есть `saved_payment_method_id` в `payment_details`
3. Проверьте логи на наличие ошибок
4. Запустите команду вручную для проверки

## Примечания

- Команда запускается каждый час, но можно изменить частоту в `routes/console.php`
- Для более частых проверок (например, каждые 15 минут) измените `->hourly()` на `->everyFifteenMinutes()`
- Команда использует `withoutOverlapping()` чтобы избежать одновременного запуска нескольких экземпляров

