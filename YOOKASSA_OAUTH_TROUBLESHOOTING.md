# Диагностика проблем с YooKassa OAuth Callback

## Возможные причины, почему callback не сработал

### 1. **Проблема с сессией (наиболее вероятно)**

- **Симптомы**: `organization_id not found in session`
- **Причины**:
    - Пользователь перешел по ссылке в другом браузере/устройстве
    - Сессия истекла между генерацией ссылки и callback'ом
    - Cookies не передаются между доменами
- **Решение**: Теперь `organization_id` кодируется в `state` параметре, поэтому не зависит от сессии

### 2. **Неверный Callback URL**

- **Симптомы**: Callback вообще не приходит на сервер
- **Проверка**:
    - Убедитесь, что в `.env` указан правильный URL: `YOOKASSA_CALLBACK_URL=https://поддержишколу.рф/yook-callback-url`
    - В настройках приложения YooKassa должен быть указан **точно такой же** URL
    - URL должен быть доступен из интернета (не localhost)
- **Решение**: Проверьте логи Laravel - если callback вообще не приходит, проблема в настройках приложения YooKassa

### 3. **Проблема с CSRF/State валидацией**

- **Симптомы**: `state mismatch` в логах
- **Причины**:
    - State не совпадает из-за проблем с сессией
    - State истек (старше 1 часа)
- **Решение**: Теперь state содержит timestamp и автоматически проверяется

### 4. **Ошибка при обмене кода на токен**

- **Симптомы**: `YooKassa OAuth token exchange failed` в логах
- **Причины**:
    - Неверный `client_id` или `client_secret`
    - Callback URL не совпадает с указанным в приложении YooKassa
    - Код авторизации уже использован (одноразовый)
- **Решение**: Проверьте логи для детальной информации об ошибке

### 5. **Проблема с middleware**

- **Симптомы**: Callback блокируется middleware
- **Проверка**: Callback роут должен быть публичным (без `auth` middleware)
- **Решение**: Убедитесь, что роут `/yook-callback-url` не защищен middleware

## Как проверить, что пошло не так

### 1. Проверьте логи Laravel

```bash
tail -f storage/logs/laravel.log
# или
tail -f storage/logs/laravel-$(date +%Y-%m-%d).log
```

Ищите записи:

- `YooKassa OAuth callback received` - callback пришел
- `YooKassa OAuth: organization_id not found` - проблема с сессией
- `YooKassa OAuth token exchange failed` - ошибка при обмене кода
- `YooKassa OAuth authorization successful` - успешная авторизация

### 2. Проверьте настройки в `.env`

```env
YOOKASSA_CLIENT_ID=ваш_client_id
YOOKASSA_CLIENT_SECRET=ваш_client_secret
YOOKASSA_CALLBACK_URL=https://поддержишколу.рф/yook-callback-url
```

### 3. Проверьте настройки приложения в YooKassa

- Callback URL должен **точно совпадать** с `YOOKASSA_CALLBACK_URL`
- Убедитесь, что приложение активно и не заблокировано

### 4. Проверьте доступность callback URL

```bash
curl -I https://поддержишколу.рф/yook-callback-url
```

Должен вернуть статус 200 или 302 (редирект)

## Что было исправлено

### 1. **Кодирование organization_id в state**

- Теперь `organization_id` кодируется в параметре `state`
- Не зависит от сессии между генерацией ссылки и callback'ом
- State содержит timestamp для проверки актуальности

### 2. **Улучшенное логирование**

- Добавлено логирование всех параметров callback'а
- Логируется IP, User-Agent, callback URL
- Детальная информация об ошибках

### 3. **Fallback механизм**

- Если state не удалось декодировать, пробуем получить из сессии
- Если сессия недоступна, но state содержит organization_id, продолжаем
- В debug режиме более мягкая валидация для отладки

## Рекомендации на будущее

### 1. **Мониторинг логов**

- Настройте мониторинг логов на ошибки OAuth
- Создайте алерты на критические ошибки

### 2. **Тестирование**

- Всегда тестируйте OAuth flow после изменений
- Проверяйте работу в разных браузерах/устройствах

### 3. **Резервный способ**

- Если callback не сработал, используйте ручной ввод OAuth токена
- Токен можно получить из ответа callback или создать новую ссылку

### 4. **Валидация настроек**

- При генерации ссылки проверяйте наличие всех необходимых настроек
- Показывайте предупреждения, если что-то не настроено

## Как восстановить после сбоя

### Вариант 1: Создать новую ссылку

1. Перейдите на страницу организации
2. Нажмите "Создать ссылку для авторизации"
3. Отправьте новую ссылку магазину
4. Магазин должен снова пройти авторизацию

### Вариант 2: Ввести токен вручную

1. Если у вас есть OAuth токен (из callback или другого источника)
2. Нажмите "Ввести OAuth токен"
3. Введите `access_token` (обязательно)
4. Опционально: `refresh_token` и `expires_in`
5. Shop ID будет получен автоматически

### Вариант 3: Привязать по Shop ID (если токен уже есть)

1. Если магазин уже авторизован, но токен не сохранен
2. Введите Shop ID через "Привязать магазин по ID"
3. Затем введите OAuth токен вручную
